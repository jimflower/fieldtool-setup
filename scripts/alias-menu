#!/usr/bin/env bash
[ -f /opt/fieldtool/config.env ] && . /opt/fieldtool/config.env || true
set -Eeuo pipefail
IF="${1:-eth0}"

echo "=== Temp aliases on $IF ==="
# Strip any trailing "\" that ip might print when wrapping
mapfile -t ENTRIES < <(
  ip -o -4 addr show dev "$IF" 2>/dev/null | sed 's/\\$//' | \
  awk -v ifc="$IF" '
    {
      cidr=$4; label="";
      for(i=1;i<=NF;i++){
        if ($i ~ "^"ifc":"){ label=$i; sub(/\\$/,"",label); break }
      }
      if (label != "") { print cidr" "label }
    }'
)

if (( ${#ENTRIES[@]} == 0 )); then
  echo "[INFO] No FieldTool-labelled aliases found on $IF."
  echo "Tip: add one with: fieldtool run ip-alias add auto:192.168.8.0/24 $IF"
  exit 0
fi

for i in "${!ENTRIES[@]}"; do
  printf "%d) %s\n" $((i+1)) "${ENTRIES[$i]}"
done

read -rp "Select number to delete (or Enter to exit): " sel
[[ -z "${sel:-}" ]] && exit 0
idx=$((sel-1))
if (( idx < 0 || idx >= ${#ENTRIES[@]} )); then
  echo "[ERR] Invalid selection"; exit 2
fi

cidr=$(awk '{print $1}' <<<"${ENTRIES[$idx]}")
label=$(awk '{print $2}' <<<"${ENTRIES[$idx]}")

# Delete; prefer using the label to remove the exact alias
if ! sudo ip addr del "$cidr" dev "$IF" label "$label" 2>/dev/null; then
  # fallback without label if kernel doesnâ€™t require it
  sudo ip addr del "$cidr" dev "$IF"
fi
echo "[OK] Removed $cidr ($label)"
