#!/usr/bin/env bash
set -euo pipefail
# optional config
[ -f /opt/fieldtool/config.env ] && . /opt/fieldtool/config.env || true

usage() {
  cat <<USG
Usage:
  ip-alias add <CIDR|auto:NET/24> [IFACE]     # e.g. add 192.168.8.50/24 eth0  | add auto:192.168.8.0/24 eth0
  ip-alias del <CIDR> [IFACE]                 # e.g. del 192.168.8.50/24 eth0
  ip-alias list [IFACE]                       # list aliases on IFACE (default eth0)
USG
}

add_alias() {
  local cidr="${1:-}"; local iface="${2:-${BRIDGE_OUT_IF:-eth0}}"
  [[ -z "$cidr"  ]] && read -rp "Subnet/IP (e.g. auto:192.168.8.0/24 or 192.168.8.50/24): " cidr
  [[ -z "${iface:-}" ]] && read -rp "Interface [eth0]: " iface || true; iface="${iface:-eth0}"
  local ip label="$iface:cam"
  if [[ "$cidr" == auto:* ]]; then
    local net="${cidr#auto:}"
    local base; base=$(echo "$net" | awk -F'[./]' '{printf "%s.%s.%s",$1,$2,$3}')
    ip="${base}.10/24"
    echo "[INFO] Auto-adding ${ip} on ${iface} (label ${label})"
  else
    ip="$cidr"; echo "[INFO] Adding ${ip} on ${iface} (label ${label})"
  fi
  sudo ip link set "$iface" up
  sudo ip addr add "$ip" dev "$iface" label "$label" 2>/dev/null || \
  sudo ip addr replace "$ip" dev "$iface" label "$label"
  ip -br addr show "$iface"
}

del_alias() {
  local cidr="${1:-}"; local iface="${2:-${BRIDGE_OUT_IF:-eth0}}"; local label="$iface:cam"
  [[ -z "${cidr:-}" ]] && { echo "[ERR] Need CIDR to delete (e.g. 192.168.8.50/24)"; exit 2; }
  sudo ip addr del "$cidr" dev "$iface" label "$label" || sudo ip addr del "$cidr" dev "$iface"
  echo "[OK] Removed $cidr ($label)"
}

list_aliases() {
  local iface="${1:-${BRIDGE_OUT_IF:-eth0}}"
  ip -o -4 addr show dev "$iface" | sed 's/\\$//' || true
}

act="${1:-}"; shift || true
case "$act" in
  add)  add_alias "$@" ;;
  del)  del_alias "$@" ;;
  list|"") list_aliases "$@" ;;
  -h|--help) usage ;;
  *) echo "[ERR] Unknown: $act"; usage; exit 2 ;;
esac
