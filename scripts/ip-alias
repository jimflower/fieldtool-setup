#!/usr/bin/env bash
[ -f /opt/fieldtool/config.env ] && . /opt/fieldtool/config.env || true
set -euo pipefail

usage() {
  cat <<USG
Usage:
  ip-alias add <CIDR|auto:NET/24> [IFACE]     # e.g. add 192.168.8.50/24 eth0  | add auto:192.168.8.0/24 eth0
  ip-alias del <CIDR> [IFACE]                 # e.g. del 192.168.8.50/24 eth0
  ip-alias list [IFACE]                       # list aliases on IFACE (default eth0)

Hints:
  - 'auto:NET/24' picks .10 on that subnet (e.g. 192.168.8.10/24).
  - Defaults: IFACE=eth0, label=\$IFACE:cam
USG
}

add_alias() {
  local cidr="${1:-}"; local iface="${2:-eth0}"
  if [[ -z "${cidr}" ]]; then
    read -rp "Subnet/IP (e.g. auto:192.168.8.0/24 or 192.168.8.50/24): " cidr
  fi
  if [[ -z "${iface}" ]]; then
    read -rp "Interface [eth0]: " iface; iface="${iface:-eth0}"
  fi

  local ip label="$iface:cam"
  if [[ "$cidr" == auto:* ]]; then
    local net="${cidr#auto:}"
    local base
    base=$(echo "$net" | awk -F'[./]' '{printf "%s.%s.%s",$1,$2,$3}')
    ip="${base}.10/24"
    echo "[INFO] Auto-adding ${ip} on ${iface} (label ${label})"
  else
    ip="$cidr"
    echo "[INFO] Adding ${ip} on ${iface} (label ${label})"
  fi

  sudo ip link set "$iface" up
  # add or replace without error spam
  sudo ip addr add "$ip" dev "$iface" label "$label" 2>/dev/null || \
  sudo ip addr replace "$ip" dev "$iface" label "$label"
  ip -br addr show "$iface"
}

del_alias() {
  local cidr="${1:-}"; local iface="${2:-eth0}"; local label="$iface:cam"
  if [[ -z "${cidr}" ]]; then
    echo "[ERR] Need CIDR to delete (e.g. 192.168.8.50/24)"; return 2
  fi
  sudo ip addr del "$cidr" dev "$iface" label "$label"
  echo "[OK] Removed $cidr from $iface ($label)"
}

list_aliases() {
  local iface="${1:-eth0}"
  ip -br addr show "$iface" || true
}

act="${1:-}" ; shift || true
case "${act}" in
  add)  add_alias "$@" ;;
  del)  del_alias "$@" ;;
  list|"") list_aliases "$@" ;;
  -h|--help) usage ;;
  *) echo "[ERR] Unknown command: ${act}"; usage; exit 2 ;;
esac
