#!/usr/bin/env bash
set -Eeuo pipefail
[ -f /opt/fieldtool/config.env ] && . /opt/fieldtool/config.env || true

IN_IF="${LAN_IF:-eth0}"
TIMEOUT=120
PROBE_IP=""
SCRIPTS_DIR="${SCRIPTS_DIR:-/opt/fieldtool/scripts}"

# Args: -i/--iface IF, -t/--timeout SECS, -p/--probe IP
while [[ $# -gt 0 ]]; do
  case "$1" in
    -i|--iface)   IN_IF="${2:-$IN_IF}"; shift 2;;
    -t|--timeout) TIMEOUT="${2:-$TIMEOUT}"; shift 2;;
    -p|--probe)   PROBE_IP="${2:-}"; shift 2;;
    *) shift;;
  esac
done
[[ "$TIMEOUT" =~ ^[0-9]+$ ]] || TIMEOUT=120

echo "[INFO] Interface: $IN_IF"
echo "[INFO] Power-cycle the device now. Listening ${TIMEOUT}s for ARP/DHCPâ€¦"

sudo mkdir -p /run/fieldtool 2>/dev/null || true
FILTER='arp or (udp and (port 67 or 68)) or (vlan and (arp or (udp and (port 67 or 68))))'

# Optional active ARP probe (helps quiet devices)
if [[ -n "$PROBE_IP" ]]; then
  (
    for _ in {1..15}; do
      sudo arping -I "$IN_IF" -c 2 -w 2 "$PROBE_IP" >/dev/null 2>&1 || true
      sleep 2
    done
  ) &
fi

while IFS= read -r line; do
  [[ "${DEBUG:-0}" != "0" ]] && echo "[DBG] $line"
  ip=""

  # DHCP OFFER/ACK: 'Your-IP X.X.X.X'
  if [[ "$line" == *"Your-IP "* ]]; then
    if [[ "$line" =~ Your-IP[[:space:]]+([0-9]+\.[0-9]+\.[0-9]+\.[0-9]+) ]]; then ip="${BASH_REMATCH[1]}"; fi

  # ARP Reply: use the replied IP
  elif [[ "$line" == *"ARP"* && "$line" == *"Reply"* && "$line" == *"is-at"* ]]; then
    if [[ "$line" =~ Reply[[:space:]]+([0-9]+\.[0-9]+\.[0-9]+\.[0-9]+)[[:space:]]+is-at ]]; then ip="${BASH_REMATCH[1]}"; fi

  # ARP Request: prefer 'tell X' if present & not 0.0.0.0, else use 'who-has Y'
  elif [[ "$line" == *"ARP"* && "$line" == *"who-has"* ]]; then
    tellIP=""; whoIP=""
    if [[ "$line" =~ who-has[[:space:]]+([0-9]+\.[0-9]+\.[0-9]+\.[0-9]+) ]]; then whoIP="${BASH_REMATCH[1]}"; fi
    if [[ "$line" =~ tell[[:space:]]+([0-9]+\.[0-9]+\.[0-9]+\.[0-9]+) ]]; then tellIP="${BASH_REMATCH[1]}"; fi
    if [[ -n "$tellIP" && "$tellIP" != "0.0.0.0" ]]; then ip="$tellIP"
    else ip="$whoIP"; fi
  fi

  if [[ -n "$ip" ]]; then
    echo "[DETECT] Device IP: $ip"
    echo "$ip" | sudo tee /run/fieldtool/last_detected_ip >/dev/null
    echo "[INFO] Handing off to bridge-auto: $SCRIPTS_DIR/bridge-auto -i $IN_IF $ip"
    "$SCRIPTS_DIR/bridge-auto" -i "$IN_IF" "$ip"
    exit 0
  fi
done < <(sudo timeout "${TIMEOUT}s" tcpdump -ni "$IN_IF" -vv -s0 -l "$FILTER" 2>/dev/null | stdbuf -oL tr -d '\r')

echo "[ERR] No ARP/DHCP seen within ${TIMEOUT}s on ${IN_IF}."
echo "[HINT] If you know a device IP, retry with: $0 -i $IN_IF -t $TIMEOUT -p <ip>"
exit 1
